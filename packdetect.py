#!/usr/bin/python

import peutils
import pefile
import argparse
import sys

def packdetect(arg_pe):
				"""attempt to detect the packer in use"""
				pe = pefile.PE(arg_pe)
				signatures = peutils.SignatureDatabase('/home/matt/tools/scripts/UserDB.TXT')
				with file('/home/matt/tools/scripts/UserDB.TXT', 'rt') as f: 
								sig_data = f.read()
				signatures = peutils.SignatureDatabase(data=sig_data)
		    		if arg_showall:
								matches = signatures.match_all(pe, ep_only = True)
				else:
								matches = signatures.match(pe, ep_only = True)
				sys.stdout.write("Possible packer: ")
				print matches

def menu():

				# menu system
				parser = argparse.ArgumentParser(description='Basic packer detector', usage='%(prog)s -f file')
				parser.add_argument('--file', '-f', dest='pefile', help='file to check')
				parser.add_argument('--all', '-a', dest='all', help='show all matches', action="store_true")
				parser.add_argument('--version', '-v', action='version', version='%(prog)s 0.1')
				args = parser.parse_args()
				
				if len(sys.argv) == 1:
								parser.print_help()
								sys.exit(1)

				arg_pe = args.pefile
				global arg_showall
				arg_showall = args.all

				if not args.pefile:
								parser.print_help()
								sys.exit(1)

				print "analysing..."
				packdetect(arg_pe)


if __name__ == '__main__':
    menu()
